#!/usr/bin/env ruby
require "fileutils"
require "open3"

APP_ROOT = File.expand_path("..", __dir__)

# Set environment variables for the script
# ENV["BULLET_RAISE"] = "false"

def system!(*args)
  system(*args, exception: true)
end

def run_command(*args, errors_only: false)
  if errors_only
    # Capture output in errors-only mode
    output, status = Open3.capture2e(*args)
    if status.success?
      # Success: suppress output
      return true
    else
      # Failure: show output then raise
      puts output
      raise "Command failed with status #{status.exitstatus}: #{args.join(' ')}"
    end
  else
    # Normal mode: stream output directly
    system(*args, exception: true)
  end
end

FileUtils.chdir APP_ROOT do
  puts "== Running setup =="
  run_command "bin/setup --skip-server", errors_only: ERRORS_ONLY

  puts "\n== Running tests =="
  run_command "bundle exec rspec", errors_only: ERRORS_ONLY

  puts "\n== Running security tests =="
  run_command "bin/brakeman", errors_only: ERRORS_ONLY

  puts "\n== Running gem security audit =="
  run_command "bundle exec bundle-audit --update", errors_only: ERRORS_ONLY

  puts "\n== Scanning for leaked secrets =="
  if system("which gitleaks > /dev/null 2>&1")
    run_command "gitleaks detect --verbose --no-git", errors_only: ERRORS_ONLY
  else
    puts "⚠️  Gitleaks not installed. Install with: brew install gitleaks"
    puts "Skipping secret scanning..."
  end

  puts "\n== Running gem security audit =="
  system! "bundle exec bundle-audit --update"

  # puts "\n== Regenerating swagger =="
  # run_command "bundle exec rake rswag:specs:swaggerize", errors_only: ERRORS_ONLY

  puts "\n== Running code quality analysis =="
  run_command "bundle exec reek .", errors_only: ERRORS_ONLY

  puts "\n== Running Rails best practices =="
  run_command "bundle exec rails_best_practices .", errors_only: ERRORS_ONLY

  puts "\n== Running code quality analysis =="
  system! "bundle exec reek ."

  puts "\n== Running Rails best practices =="
  system! "bundle exec rails_best_practices ."

  puts "\n== Running lints =="
  run_command "bin/rubocop -A", errors_only: ERRORS_ONLY

  puts "\n== Running YARD documentation checks =="
  run_command "bundle exec yardoc --no-output --no-cache --fail-on-warning", errors_only: ERRORS_ONLY

  puts "\n== Updating model annotations =="
  run_command "bundle exec annotaterb models", errors_only: ERRORS_ONLY

  puts "\n== All checks passed! =="
end
