<%= form_with(model: activity, local: true, class: "space-y-6") do |form| %>
  <% if activity.errors.any? %>
    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 15.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-red-800">
            <%= pluralize(activity.errors.count, "error") %> prohibited this activity from being saved:
          </h3>
          <div class="mt-2 text-sm text-red-700">
            <ul class="list-disc list-inside space-y-1">
              <% activity.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div>
    <%= form.label :name, class: "block text-sm font-medium text-gray-700 mb-2" %>
    <%= form.text_field :name, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500", placeholder: "e.g., Pub Trivia at the Willows" %>
  </div>

  <div>
    <%= form.label :description, class: "block text-sm font-medium text-gray-700 mb-2" %>
    <%= form.text_area :description, rows: 4, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500", placeholder: "Describe the activity..." %>
  </div>

  <div>
    <%= form.label :schedule_type, "Schedule Type", class: "block text-sm font-medium text-gray-700 mb-2" %>
    <%= form.select :schedule_type,
        options_for_select(schedule_type_options, activity.schedule_type),
        { prompt: 'Select schedule type...' },
        { class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500", id: "schedule_type_select" } %>
  </div>

  <!-- Strict Schedule Fields -->
  <div id="strict_fields" class="space-y-4" style="display: none;">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <%= form.label :start_time, "Start Date & Time", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= form.datetime_local_field :start_time, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" %>
      </div>
      <div>
        <%= form.label :end_time, "End Date & Time", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= form.datetime_local_field :end_time, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" %>
      </div>
    </div>
  </div>

  <!-- Deadline Fields -->
  <div id="deadline_fields" style="display: none;">
    <div>
      <%= form.label :deadline, "Deadline", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.date_field :deadline, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" %>
    </div>
  </div>

  <!-- Recurring Fields -->
  <div id="recurring_fields" class="space-y-4" style="display: none;">
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
      <h3 class="text-sm font-medium text-blue-900 mb-3">Recurrence Pattern</h3>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <%= form.label :recurrence_frequency, "Repeats", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= select_tag 'recurrence_frequency',
              options_for_select(recurrence_frequency_options, activity.recurrence_rule&.dig('freq')),
              { prompt: 'Select frequency...', class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500", id: "recurrence_frequency_select" } %>
        </div>
        <div>
          <%= form.label :recurrence_interval, "Every", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= number_field_tag 'recurrence_interval',
              activity.recurrence_rule&.dig('interval') || 1,
              { min: 1, max: 52, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500", id: "recurrence_interval" } %>
          <p class="text-xs text-gray-500 mt-1" id="interval_label">week(s)</p>
        </div>
      </div>

      <!-- Weekly: Days of Week -->
      <div id="weekly_options" style="display: none;" class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">On these days</label>
        <div class="flex flex-wrap gap-2">
          <% day_of_week_options.each do |label, value| %>
            <label class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer">
              <%= check_box_tag "byday[]", value, (activity.recurrence_rule&.dig('byday') || []).include?(value), class: "mr-2" %>
              <span class="text-sm"><%= label %></span>
            </label>
          <% end %>
        </div>
      </div>

      <!-- Monthly: By Date or By Position -->
      <div id="monthly_options" style="display: none;" class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Repeat by</label>
        <div class="space-y-3">
          <label class="flex items-center">
            <%= radio_button_tag 'monthly_type', 'bymonthday', true, class: "mr-2", id: "monthly_by_date" %>
            <span class="text-sm">Day of month (e.g., 15th)</span>
          </label>
          <div id="monthday_input" class="ml-6">
            <%= number_field_tag 'bymonthday',
                activity.recurrence_rule&.dig('bymonthday')&.first || Date.current.day,
                { min: 1, max: 31, class: "w-32 px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" } %>
          </div>

          <label class="flex items-center">
            <%= radio_button_tag 'monthly_type', 'bysetpos', false, class: "mr-2", id: "monthly_by_position" %>
            <span class="text-sm">Position and day (e.g., 1st Sunday)</span>
          </label>
          <div id="position_inputs" class="ml-6 grid grid-cols-2 gap-2" style="display: none;">
            <%= select_tag 'bysetpos',
                options_for_select(monthly_position_options, activity.recurrence_rule&.dig('bysetpos')&.first),
                { class: "px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" } %>
            <%= select_tag 'monthly_byday',
                options_for_select(day_of_week_options, activity.recurrence_rule&.dig('byday')&.first),
                { class: "px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" } %>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <%= form.label :recurrence_start_date, "Starts on", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.date_field :recurrence_start_date, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" %>
        </div>
        <div>
          <%= form.label :recurrence_end_date, "Ends on (optional)", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.date_field :recurrence_end_date, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" %>
        </div>
      </div>
    </div>

    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
      <h3 class="text-sm font-medium text-green-900 mb-3">Event Time</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <%= form.label :occurrence_time_start, "Start time", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.time_field :occurrence_time_start, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" %>
        </div>
        <div>
          <%= form.label :occurrence_time_end, "End time", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.time_field :occurrence_time_end, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" %>
        </div>
      </div>
      <div class="mt-4">
        <%= form.label :duration_minutes, "I'll attend for (minutes, optional)", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <%= form.number_field :duration_minutes, min: 1, max: 720, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500", placeholder: "Leave blank to attend for the full event duration" %>
        <p class="text-xs text-gray-500 mt-1">If the event runs longer than you'll attend, specify your attendance duration</p>
      </div>
    </div>
  </div>

  <!-- Duration for Flexible/Deadline Activities -->
  <div id="duration_field" style="display: none;">
    <div>
      <%= form.label :duration_minutes, "Duration (minutes)", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.number_field :duration_minutes, min: 1, max: 720, class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500", placeholder: "60" %>
      <p class="text-xs text-gray-500 mt-1">How long does this activity take? (default: 60 minutes)</p>
    </div>
  </div>

  <div id="max_frequency_field">
    <%= form.label :max_frequency_days, "Repeat Frequency", class: "block text-sm font-medium text-gray-700 mb-2" %>
    <%= form.select :max_frequency_days,
        options_for_select(max_frequency_options, activity.max_frequency_days),
        { prompt: 'How often would you like to repeat this?' },
        { class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" } %>
  </div>

  <div>
    <%= form.label :links, "Related Links (optional)", class: "block text-sm font-medium text-gray-700 mb-2" %>
    <div id="links_container">
      <% activity.activity_links.each_with_index do |link, index| %>
        <div class="flex mb-2">
          <input type="text" name="activity[links][]" value="<%= link %>" placeholder="https://example.com" class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500">
          <button type="button" onclick="removeLink(this)" class="px-3 py-2 bg-red-500 text-white rounded-r-lg hover:bg-red-600">Remove</button>
        </div>
      <% end %>
    </div>
    <button type="button" onclick="addLink()" class="mt-2 text-blue-600 hover:text-blue-800 text-sm font-medium">+ Add Link</button>
  </div>

  <div class="flex justify-end space-x-3 pt-4 border-t">
    <%= link_to "Cancel", activities_path, class: "px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition duration-200" %>
    <%= form.submit class: "px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition duration-200" %>
  </div>
<% end %>

<script>
  function toggleScheduleFields() {
    const scheduleType = document.getElementById('schedule_type_select').value;
    const strictFields = document.getElementById('strict_fields');
    const deadlineFields = document.getElementById('deadline_fields');
    const recurringFields = document.getElementById('recurring_fields');
    const durationField = document.getElementById('duration_field');
    const maxFrequencyField = document.getElementById('max_frequency_field');

    // Hide all conditional fields
    strictFields.style.display = 'none';
    deadlineFields.style.display = 'none';
    recurringFields.style.display = 'none';
    durationField.style.display = 'none';

    // Show relevant fields
    if (scheduleType === 'strict') {
      strictFields.style.display = 'block';
      maxFrequencyField.style.display = 'block';
    } else if (scheduleType === 'deadline') {
      deadlineFields.style.display = 'block';
      durationField.style.display = 'block';
      maxFrequencyField.style.display = 'block';
    } else if (scheduleType === 'recurring_strict') {
      recurringFields.style.display = 'block';
      maxFrequencyField.style.display = 'none';
    } else if (scheduleType === 'flexible') {
      durationField.style.display = 'block';
      maxFrequencyField.style.display = 'block';
    }
  }

  function toggleRecurrenceOptions() {
    const freq = document.getElementById('recurrence_frequency_select')?.value;
    const weeklyOptions = document.getElementById('weekly_options');
    const monthlyOptions = document.getElementById('monthly_options');
    const intervalLabel = document.getElementById('interval_label');

    // Hide all
    if (weeklyOptions) weeklyOptions.style.display = 'none';
    if (monthlyOptions) monthlyOptions.style.display = 'none';

    // Update interval label
    if (intervalLabel) {
      switch(freq) {
        case 'DAILY':
          intervalLabel.textContent = 'day(s)';
          break;
        case 'WEEKLY':
          intervalLabel.textContent = 'week(s)';
          if (weeklyOptions) weeklyOptions.style.display = 'block';
          break;
        case 'MONTHLY':
          intervalLabel.textContent = 'month(s)';
          if (monthlyOptions) monthlyOptions.style.display = 'block';
          break;
        case 'YEARLY':
          intervalLabel.textContent = 'year(s)';
          break;
      }
    }
  }

  function toggleMonthlyType() {
    const byDate = document.getElementById('monthly_by_date')?.checked;
    const monthdayInput = document.getElementById('monthday_input');
    const positionInputs = document.getElementById('position_inputs');

    if (monthdayInput) {
      monthdayInput.style.display = byDate ? 'block' : 'none';
    }
    if (positionInputs) {
      positionInputs.style.display = byDate ? 'none' : 'grid';
    }
  }

  function buildRecurrenceRule() {
    const freq = document.getElementById('recurrence_frequency_select')?.value;
    if (!freq) return null;

    const interval = parseInt(document.getElementById('recurrence_interval')?.value || 1);
    const rule = { freq: freq, interval: interval };

    if (freq === 'WEEKLY') {
      const checkedDays = Array.from(document.querySelectorAll('input[name="byday[]"]:checked'))
        .map(cb => cb.value);
      if (checkedDays.length > 0) {
        rule.byday = checkedDays;
      }
    } else if (freq === 'MONTHLY') {
      const byDate = document.getElementById('monthly_by_date')?.checked;
      if (byDate) {
        const monthday = parseInt(document.querySelector('input[name="bymonthday"]')?.value || 1);
        rule.bymonthday = [monthday];
      } else {
        const position = parseInt(document.querySelector('select[name="bysetpos"]')?.value || 1);
        const day = document.querySelector('select[name="monthly_byday"]')?.value;
        rule.bysetpos = [position];
        rule.byday = [day];
      }
    }

    return rule;
  }

  function addLink() {
    const container = document.getElementById('links_container');
    const div = document.createElement('div');
    div.className = 'flex mb-2';
    div.innerHTML = `
      <input type="text" name="activity[links][]" placeholder="https://example.com" class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500">
      <button type="button" onclick="removeLink(this)" class="px-3 py-2 bg-red-500 text-white rounded-r-lg hover:bg-red-600">Remove</button>
    `;
    container.appendChild(div);
  }

  function removeLink(button) {
    button.parentElement.remove();
  }

  // Initialize form
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const scheduleTypeSelect = document.getElementById('schedule_type_select');
    const recurrenceFreqSelect = document.getElementById('recurrence_frequency_select');
    const monthlyByDate = document.getElementById('monthly_by_date');
    const monthlyByPosition = document.getElementById('monthly_by_position');

    // Initial setup
    toggleScheduleFields();
    if (scheduleTypeSelect) {
      scheduleTypeSelect.addEventListener('change', toggleScheduleFields);
    }

    if (recurrenceFreqSelect) {
      toggleRecurrenceOptions();
      recurrenceFreqSelect.addEventListener('change', toggleRecurrenceOptions);
    }

    if (monthlyByDate && monthlyByPosition) {
      toggleMonthlyType();
      monthlyByDate.addEventListener('change', toggleMonthlyType);
      monthlyByPosition.addEventListener('change', toggleMonthlyType);
    }

    // Handle form submission to build recurrence_rule JSON
    if (form) {
      form.addEventListener('submit', function(e) {
        const scheduleType = scheduleTypeSelect?.value;
        if (scheduleType === 'recurring_strict') {
          const rule = buildRecurrenceRule();
          if (rule) {
            // Create hidden field with JSON
            const hiddenField = document.createElement('input');
            hiddenField.type = 'hidden';
            hiddenField.name = 'activity[recurrence_rule]';
            hiddenField.value = JSON.stringify(rule);
            form.appendChild(hiddenField);
          }
        }
      });
    }
  });
</script>